<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>stuff and quite possibly things</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Overpass:wght@500;600;700&display=swap');

    body {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      overflow-x: hidden;
      font-family: 'Overpass', sans-serif !important;
      color: #fefefe;
      padding: 20px;
      background-color: black;
    }

    .camera {
      margin: 10px;
      padding: 20px;
      width: 320px;
      height: auto;
      background-color: rgba(0, 132, 80, 0.8);
      font-style: 700;
      align-items: center;
      border: 4px solid #fefefe;
      border-radius: 8px;
      display: none;
      box-shadow: inset 0 10px 20px rgba(0, 0, 0, .075), 0 0 10px rgba(255, 255, 255, 0.6);
      transition: all 0.5s ease !important;
    }

    .camera h1 {
        margin: 0px !important;
    }

    .camera video {
        border-radius: 8px;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px;
      width: 100%;
    }

    button, input  {
      background-color: rgba(0, 132, 80, 1);
      color: #fefefe;
      border: 3px solid #fefefe;
      box-shadow: inset 0 10px 20px rgba(0, 0, 0, .075), 0 0 5px rgba(255, 255, 255, 0.6);
      border-radius: 5px;
      padding: 8px 16px;
      font-family: 'Overpass', sans-serif !important;
      cursor: pointer;
      margin: 0 5px;
    }

    input {
        width: 50px;
    }

    button:hover {
        background-color: rgba(0, 132, 80, 0.7);
    }

    button:disabled {
        opacity: 0.7;
    }

    .statusContainer {
        width: 100%;
        font-size: 22px;
        margin-bottom: -20px;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
    }

    .inputContainer {
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;
        margin: 0px 0px 20px 0px;
    }

    #searchCamera {
      width: auto;
    }

    .searchContainer {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: -10px 0px 15px 0px;
    }

    #realCredits {
        position: fixed;
        bottom: 0px;
        left: 20px;
    }
  </style>
</head>
<body>
    <div class="statusContainer">
        <span>STATUS: &nbsp;</span><p id="currentStatus">...&nbsp;</p>
    </div>
    <div class="pagination">
        <button id="prevPage" onclick="prevPage()">PREVIOUS</button>
        <button id="nextPage" onclick="nextPage()">NEXT</button>
        <button id="randomPage" onclick="randomPage()">RANDOM</button>
        <p id="pageCounter" style="font-size: 15px">&nbsp; (PAGE 1/?)</p>
    </div>
    <div class="searchContainer">
      <input type="number" id="searchCamera" placeholder="Camera Number" min="0">
      <button id="searchBtn" onclick="searchCamera()">SEARCH</button>
      <button id="pauseBtn" onclick="pauseLoading()" ondblclick="pauseAll()">PAUSE</button>
      <button id="clearBtn" onclick="clearAll()">CLEAR</button>
    </div>
    <div class="inputContainer">
        <label for="camerasPerPage">CAMERAS PER PAGE: &nbsp;</label>
        <input type="number" id="camerasPerPage" value="30" min="1" onchange="updateCamerasPerPage();">
    </div>
    
    <p id="realCredits"><span style="color: red">NOT</span> created by dris elamri</p>
    
  <script>
//record and save locally on browser
//save/favorite certain cameras
//search for specific cameras
//ACTUALLY EFFICIENT SEARCHING ALGORITHIM
//cookies

    const cameraBaseUrl = 'https://video.dot.state.mn.us/public/';
    const minCameraNumber = 0;
    const maxCameraNumber = 5000; //idk where it actually ends
    let camerasPerPage = 30;
    let currentPage = 0;
    let isLoading = false;
    let isPaused = false;
    let i = 0;
    let lastCheckedCamera = 0;
    let activeCameraArr = [];

    const currentStatus = document.getElementById("currentStatus");
    const pageCounter = document.getElementById("pageCounter");
    const prevPageButton = document.getElementById("prevPage");
    const nextPageButton = document.getElementById("nextPage");

    async function checkCamera(cameraNumber) {
    if (isPaused) return false;

    const url = `${cameraBaseUrl}C${cameraNumber}.stream/playlist.m3u8`;
      try {
        const response = await fetch(url, { method: 'HEAD' });
        currentStatus.style.color = "GREEN";
        activeCameraArr.push(cameraNumber);
        return response.ok;
      } catch (error) {
        currentStatus.style.color = "RED";
        return false;
      }
    }


    async function loadCameras(start, end) {
        isLoading = true;
        prevPageButton.disabled = true;
        nextPageButton.disabled = true;

        let activeCameras = 0;
        // i += minCameraNumber
    for (i = minCameraNumber; activeCameras <= end && i <= maxCameraNumber; i++) {
        currentStatus.innerHTML = `Checking C${i}...&nbsp;`;
        if (await checkCamera(i)) {
        console.log(activeCameraArr);
        activeCameras++;

        if (activeCameras >= start + 1) {
          const url = `${cameraBaseUrl}C${i}.stream/playlist.m3u8`;
          addCamera(i, url);
        }
        }
    }
    lastCheckedCamera = i;
    console.log(lastCheckedCamera);
    currentStatus.style.color = "WHITE";
    currentStatus.innerHTML = `Finished (${(currentPage * camerasPerPage) + camerasPerPage} found)&nbsp;`;
    isLoading = false;
      prevPageButton.disabled = currentPage === 0;
      nextPageButton.disabled = false;
    }

    function clearCameras() {
      const cameras = document.querySelectorAll('.camera');
      cameras.forEach((camera) => camera.remove());
    }

    function nextPage() {
        if (!isLoading) {
            clearCameras();
            currentPage++;
            pageCounter.innerHTML = `&nbsp; (PAGE ${currentPage + 1}/?)`;
            // loadCameras(0, camerasPerPage - 1);
            loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);
      }
    }

    function prevPage() {
        if (!isLoading && currentPage > 0) {
            clearCameras();
            currentPage--;
            pageCounter.innerHTML = `&nbsp; (PAGE ${currentPage + 1}/?)`;
            // loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);
            loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);
        }
    }

    function randomPage() {
        if (!isLoading) {
            clearCameras();
            const randomStart = Math.floor(Math.random() * (maxCameraNumber - camerasPerPage + 1));
            loadCameras(randomStart, randomStart + camerasPerPage - 1);
        }
    }


    function updateCamerasPerPage() {
        const newCamerasPerPage = parseInt(document.getElementById("camerasPerPage").value);
        if (newCamerasPerPage > 0) {
            camerasPerPage = newCamerasPerPage;
            currentPage = 0;
            clearCameras();
            loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);
        }
    }

    async function searchCamera() {
        const cameraNumber = parseInt(document.getElementById("searchCamera").value);
        if (cameraNumber >= minCameraNumber && cameraNumber <= maxCameraNumber) {
          if (await checkCamera(cameraNumber)) {
            const url = `${cameraBaseUrl}C${cameraNumber}.stream/playlist.m3u8`;
            addCamera(cameraNumber, url);
          } else {
            alert(`Camera C${cameraNumber} not found.`);
          }
        } else {
          alert(`Invalid camera number. Please enter a number between ${minCameraNumber} and ${maxCameraNumber}.`);
        }
    }

      function pauseAll() {
        const videos = document.querySelectorAll("video");
        videos.forEach((video) => {
          if (!video.paused) {
            document.getElementById("pauseBtn").innerHTML = "PLAY";
            video.pause();
          } else {
            document.getElementById("pauseBtn").innerHTML = "PAUSE";
            video.play();
          }
        });
      }

      function pauseLoading() {
        isPaused = !isPaused;
        if (isPaused) {
          document.getElementById("pauseBtn").innerHTML = "RESUME";
        } else {
          document.getElementById("pauseBtn").innerHTML = "PAUSE";
          loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);
        }
      }


      function clearAll() {
        clearCameras();
        currentPage = 0;
        pageCounter.innerHTML = `&nbsp; (PAGE ${currentPage + 1}/?)`;
      }


        function addCamera(cameraNumber, url) {
      const cameraElement = document.createElement("div");
      cameraElement.className = "camera";
      cameraElement.innerHTML = `
        <h1>CAMERA C${cameraNumber}</h1>
        <button class="downloadBtn" onclick="downloadVideo(this)">DOWNLOAD</button>
        <video width="320" height="240" controls autoplay></video>
        <p class="downloadStatus" style="display:none"></p>
      `;
      document.body.appendChild(cameraElement);
      cameraElement.style.display = "block";

      const video = cameraElement.querySelector("video");
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function () {
          video.play();
        });
      } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
        video.src = url;
        video.addEventListener("loadedmetadata", function () {
          video.play();
        });
      }
    }

    async function downloadVideo(downloadBtn) {
  const cameraElement = downloadBtn.parentElement;
  const video = cameraElement.querySelector("video");
  const downloadStatus = cameraElement.querySelector(".downloadStatus");
  const cameraNumber = cameraElement.querySelector("h1").innerText.replace("CAMERA C", "");

  if (!video.src) {
    downloadStatus.style.display = "block";
    downloadStatus.innerText = "Video source not found.";
    return;
  }

  downloadStatus.style.display = "block";
  downloadStatus.innerText = "Recording...";

  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  const drawVideoFrame = () => {
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  };

  const stream = canvas.captureStream(25);
  const mediaRecorder = new MediaRecorder(stream);
  const chunks = [];

  mediaRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) {
      chunks.push(e.data);
    }
  };

  mediaRecorder.onstop = () => {
    downloadStatus.innerText = "Saving...";
    const blob = new Blob(chunks, { type: "video/webm" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `Camera_C${cameraNumber}.webm`;
    a.click();
    URL.revokeObjectURL(url);
    downloadStatus.style.display = "none";
  };

  const frameInterval = 1000 / 25; 
  const intervalId = setInterval(drawVideoFrame, frameInterval);

  mediaRecorder.start();
  downloadBtn.disabled = true;
  setTimeout(() => {
    mediaRecorder.stop();
    clearInterval(intervalId);
    downloadBtn.disabled = false;
  }, 10000); 
}


    loadCameras(currentPage * camerasPerPage, (currentPage * camerasPerPage) + camerasPerPage - 1);

  </script>
</body>
</html>